<%
  // Locals & safe fallbacks
  const U       = (typeof user   !== "undefined" && user)   ? user   : null;
  const ACTIVE  = (typeof active !== "undefined") ? active   : "dashboard";
  const REDDIT  = (typeof reddit !== "undefined" && reddit) ? reddit : null;
  const DISCORD = (typeof discord !== "undefined" && discord) ? discord : null;
  const NEXT    = (typeof next   !== "undefined") ? next     : "/dashboard";

  // Avatars (Discord first, then Reddit)
  const discordAvatar = DISCORD && DISCORD.avatar_url ? DISCORD.avatar_url : (U && U.avatar ? U.avatar : null);
  const redditAvatar  = REDDIT && REDDIT.avatar_url ? REDDIT.avatar_url : null;
  const primaryAvatar = discordAvatar || redditAvatar || null;

  // Names
  const displayName   = U && (U.name || U.email) ? (U.name || U.email) : "user@redup.app";
  const initial       = (U && U.name ? U.name.charAt(0) : "R").toUpperCase();

  // Reddit identity to display/link
  const redditName    = REDDIT
    ? (REDDIT.username || REDDIT.display_name || REDDIT.account_id || "")
    : "";
  const redditUrl     = redditName
    ? `https://www.reddit.com/user/${encodeURIComponent(redditName)}`
    : "#";
%>

<header class="fixed top-0 left-0 right-0 z-40 border-b border-slate-800 bg-slate-900/70 backdrop-blur h-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">
    <!-- Left: brand + breadcrumb + mobile menu -->
    <div class="flex items-center gap-3">
      <button type="button" data-open-sidebar
        class="md:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg bg-slate-900 border border-slate-800 text-slate-300"
        aria-label="Open navigation">
        <i class="ri-menu-line"></i>
      </button>

      <a href="/" class="text-2xl font-extrabold tracking-tight text-red-500">Redup</a>
      <span class="hidden sm:inline text-slate-600">/</span>
      <span class="hidden sm:inline text-slate-400 capitalize"><%= ACTIVE %></span>
    </div>

    <!-- Center: search (md+) -->
    <div class="hidden md:flex items-center flex-1 mx-6">
      <form action="/search" class="w-full" method="get">
        <input name="q" placeholder="Search posts, subreddits, campaignsâ€¦"
               class="w-full rounded-xl bg-slate-900/70 border border-slate-800 px-3 py-2 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-red-500"/>
      </form>
    </div>

    <!-- Right: actions -->
    <div class="flex items-center gap-2 sm:gap-3">
      <% if (REDDIT && redditName) { %>
        <a href="<%= redditUrl %>" target="_blank" rel="noopener"
           class="hidden md:inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg border border-emerald-500/30 bg-emerald-500/10 text-emerald-200 text-xs hover:bg-emerald-500/15">
          <i class="ri-reddit-line"></i>
          u/<%= redditName %>
        </a>
      <% } else { %>
        <a href="/connect/reddit?next=<%= encodeURIComponent(NEXT) %>"
           class="hidden md:inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-red-600/30 bg-red-600/15 text-red-200 text-xs hover:bg-red-600/20">
          <i class="ri-plug-line"></i> Connect Reddit
        </a>
      <% } %>

      <a href="/scheduler"
         class="hidden sm:inline-flex px-3 py-1.5 rounded-lg bg-gradient-to-r from-red-600 to-pink-500 text-white shadow-md hover:opacity-95">
        Schedule
      </a>

      <!-- Profile dropdown (click to open) -->
      <div class="relative" data-menu-root>
        <button type="button" data-menu-btn
          class="relative w-9 h-9 rounded-full border border-red-500/40 bg-red-500/20 text-red-300 overflow-hidden"
          aria-haspopup="menu" aria-expanded="false" aria-controls="profile-menu">
          <% if (primaryAvatar) { %>
            <img src="<%= primaryAvatar %>" alt="avatar" class="w-full h-full object-cover">
          <% } else { %>
            <span class="w-full h-full grid place-items-center"><%= initial %></span>
          <% } %>

          <% if (REDDIT) { %>
            <% if (redditAvatar) { %>
              <img src="<%= redditAvatar %>" alt="reddit" class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full border border-slate-900 shadow" />
            <% } else { %>
              <span class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full grid place-items-center bg-emerald-500/20 border border-emerald-500/40 text-emerald-300">
                <i class="ri-reddit-line text-[12px]"></i>
              </span>
            <% } %>
          <% } %>
        </button>

        <!-- Menu (JS toggled; no hover gap issues) -->
        <div id="profile-menu" role="menu" data-menu
             class="absolute right-0 mt-2 w-64 rounded-xl border border-slate-800 bg-slate-900/95 p-2 shadow-xl
                    opacity-0 -translate-y-1 pointer-events-none transition">
          <div class="px-2 py-2 flex items-center gap-2">
            <div class="relative w-9 h-9 rounded-full overflow-hidden border border-slate-700">
              <% if (primaryAvatar) { %>
                <img src="<%= primaryAvatar %>" alt="avatar" class="w-full h-full object-cover">
              <% } else { %>
                <div class="w-full h-full grid place-items-center bg-red-500/20 text-red-300"><%= initial %></div>
              <% } %>
              <% if (REDDIT && redditAvatar) { %>
                <img src="<%= redditAvatar %>" alt="reddit" class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border border-slate-900" />
              <% } %>
            </div>
            <div class="min-w-0">
              <div class="text-slate-200 text-sm truncate"><%= displayName %></div>
              <% if (REDDIT && redditName) { %>
                <a href="<%= redditUrl %>" target="_blank" rel="noopener"
                   class="text-xs text-emerald-300 hover:text-emerald-200">u/<%= redditName %></a>
              <% } else { %>
                <span class="text-xs text-slate-400">Reddit not connected</span>
              <% } %>
            </div>
          </div>

          <% if (!REDDIT) { %>
            <a class="block px-2 py-1.5 rounded hover:bg-slate-800 text-sm text-slate-200"
               href="/connect/reddit?next=<%= encodeURIComponent(NEXT) %>">
              <i class="ri-plug-line mr-1 align-[-2px]"></i> Connect Reddit
            </a>
          <% } else { %>
            <a class="block px-2 py-1.5 rounded hover:bg-slate-800 text-sm text-slate-200"
               href="<%= redditUrl %>" target="_blank" rel="noopener">
              <i class="ri-external-link-line mr-1 align-[-2px]"></i> View Reddit profile
            </a>
          <% } %>

          <a class="block px-2 py-1.5 rounded hover:bg-slate-800 text-sm text-slate-200" href="/settings">
            <i class="ri-settings-3-line mr-1 align-[-2px]"></i> Settings
          </a>
          <form method="post" action="/auth/logout">
            <button class="w-full text-left px-2 py-1.5 rounded hover:bg-slate-800 text-sm text-slate-200">
              <i class="ri-logout-box-r-line mr-1 align-[-2px]"></i> Logout
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</header>
